{% load i18n %}

{% if advreport %}
<link rel="stylesheet" type="text/css" href="{% include "advanced_reports/static.inc" %}advanced_reports/css/show-notice.css"/>
<script language="javascript" type="text/javascript" src="{% include "advanced_reports/static.inc" %}advanced_reports/js/show-notice.js"></script>
<link rel="stylesheet" type="text/css" href="{% include "advanced_reports/static.inc" %}advanced_reports/css/ui.datepicker.css"/>
<script language="javascript" type="text/javascript" src="{% include "advanced_reports/static.inc" %}advanced_reports/js/ui.datepicker.js"></script>
<link rel="stylesheet" type="text/css" href="{% include "advanced_reports/static.inc" %}advanced_reports/css/jquery.mbox.css"/>
<script language="javascript" type="text/javascript" src="{% include "advanced_reports/static.inc" %}advanced_reports/js/jquery.mbox.js"></script>


<script type="text/javascript">
    // <![CDATA[
    var test;

    $(function(){
        $('.{{ advreport.slug }}').addClass('selected');

        $('.date_range').each(function() {
            var date_picker_options = {showOn: 'button',
                                       buttonImage: '{% include "advanced_reports/static.inc" %}advanced_reports/img/calendar.png',
                                       buttonImageOnly: true,
                                       dateFormat: 'yy-mm-dd',
                                       maxDate:'+0D',
                                       firstDay: 1,
                                       dayNamesMin: ['{% trans "Su" %}',
                                                     '{% trans "Mo" %}',
                                                     '{% trans "Tu" %}',
                                                     '{% trans "We" %}',
                                                     '{% trans "Th" %}',
                                                     '{% trans "Fr" %}',
                                                     '{% trans "Sa" %}'],
                                       monthNames: ['{% trans "January" %}',
                                                    '{% trans "February" %}',
                                                    '{% trans "March" %}',
                                                    '{% trans "April" %}',
                                                    '{% trans "May" %}',
                                                    '{% trans "June" %}',
                                                    '{% trans "July" %}',
                                                    '{% trans "August" %}',
                                                    '{% trans "September" %}',
                                                    '{% trans "October" %}',
                                                    '{% trans "November" %}',
                                                    '{% trans "December" %}']};

            $(this).datepicker(date_picker_options);
        });

        $('.select-all').click(function(){
            $('.information-checkbox').attr('checked', true);
            $('#selector').attr('checked', true);
            update_checkboxes();
            return false;
        });

        $('.select-none').click(function(){
            $('.information-checkbox').attr('checked', false);
            $('#selector').attr('checked', false);
            update_checkboxes();
            return false;
        });

        $('.select-toggle').click(function(){
            $('.information-checkbox').click();
            $('#selector').attr('checked', false);
            update_checkboxes();
            return false;
        });

        function update_checkboxes()
        {
            $('.information-checkbox').each(function(){
                var checkbox = $(this);
                var hidden = $('#' + checkbox.attr('id').replace('checkbox_', 'hidden_checkbox_'));
                hidden.attr('value', checkbox.is(':checked') ? 'true' : 'false');
            });
        }

        $('#selector').live('click', function(){
            if ($(this).is(":checked")) {
                $(".information-checkbox").attr("checked", "checked");
            } else {
                $(".information-checkbox").removeAttr("checked");
            }
            update_checkboxes();
        });

        $('.multiple-action-form input[type="submit"]').click(function(){
            var method = $('#select-method').val();
            if (method == '')
                return false;

            var execute = function(){
                $('.multiple-action-form').submit();
            };

            if ($('.confirm_' + method).attr('x:confirm'))
                $.mbox(('{% trans "Confirm" %}'), $('.confirm_' + method).attr('x:confirm'), { type: DIALOG_YES_NO, callback_closed_yes: execute});
            else
                execute();
            return false;
        });

        function handle_lazy(container)
        {
            container.find('.lazy').each(function(){
                var lazy_div = $(this);
                lazy_div.html('<img class="loader" src="{{ MEDIA_URL }}common/img/loader.gif" alt=""/>');
                lazy_div.find('.loader').show();
                var object_id = '0';
                if (container.attr('id'))
                    object_id = container.attr('id').split('_')[1];
                
                var url = '{% url advanced_reports_list advreport.slug %}action/' + lazy_div.attr('x:method') + '/' + object_id + '/';
                $.ajax({
                    'type': 'GET',
                    'url': url,
                    'dataType': 'text',
                    'success': function(x) {
                        lazy_div.find('.loader').hide();
                        //lazy_div.removeClass('lazy');
                        lazy_div.html(x);
                    },
                    'error': function(x) {
                        lazy_div.find('.loader').hide();
                        lazy_div.text('error');
                    }
                });
            });
        }

        function connect_row(action_row, initialHide)
        {
            var data_row        = action_row.prev();
            var show_options    = data_row.find('.show-options');
            var hide_options    = data_row.find('.hide-options');
            var checkbox        = data_row.find('.information-checkbox');

            if (initialHide && $('.action-row').length > 1)
                collapse_row();
            else
                expand_row();

            function expand_row()
            {
                {% if advreport.animation %}action_row.slideDown('fast');{% else %}action_row.show();{% endif %}
                show_options.hide();
                hide_options.show();
                action_row.find('input[type=text]').eq(0).focus();
                handle_lazy(action_row);
            }

            function collapse_row()
            {
                {% if advreport.animation %}action_row.slideUp('fast');{% else %}action_row.hide();{% endif %}
                show_options.show();
                hide_options.hide();
            }

            show_options.click(function(){ expand_row(); return false; });
            hide_options.click(function(){ collapse_row(); return false; });

            function handle_checkbox_click()
            {
                var hidden = $('#' + checkbox.attr('id').replace('checkbox_', 'hidden_checkbox_'));
                hidden.attr('value', checkbox.is(':checked') ? 'true' : 'false');
                if (!checkbox.is(':checked'))
                    $('#selector').attr('checked', false);
            }

            data_row.click(function(e){
                if (action_row.is(':visible')) collapse_row(); else expand_row();
                if (action_row.hasClass('empty-row'))
                {
                    checkbox.attr('checked', !checkbox.attr('checked'));
                    handle_checkbox_click();
                }
                e.stopPropagation();
            });

            data_row.find('a').each(function(){
                var link = $(this);
                link.click(function(e){ e.stopPropagation(); });
            });

            action_row.find('.action-form').each(function(){
                var form = $(this);
                connect_form(form, action_row, data_row);
            });

            action_row.find('.collapse-form').each(function(){
                $(this).addClass('inline').removeClass('limit-width');
            });

            action_row.find('.action-link').each(function(){
                var link = $(this);
                if (!link.hasClass('form-via-ajax')) {
                    connect_link(link, action_row, data_row);
                }
            });

            checkbox.click(function(e){
                handle_checkbox_click();
                e.stopPropagation();
            });
            
            action_row.find('.form-via-ajax').each(function(){
                var link = $(this);
                
                link.click(function(){
                    var action_name = link.text();
                    var title = link.attr('x:confirm');
                    if (!title || title == "") {
                        title = action_name;
                    }
                    var submit_caption = link.attr('x:submit');
                    if (!submit_caption || submit_caption == "") {
                        submit_caption = action_name;
                    }
                
                    $.mbox_ajax_form(
                        title,
                        link.attr("href"),
                        submit_caption,
                        {
                            'width': '600px',
                            'response_type': RESPONSE_JSON,
                            'callback_ajax_posted_success': function(mbox_element, data){
                                replace_rows(data, action_row, data_row, link.attr('x:next') == "true");
                                return true;
                            }
                        }
                    );
                    
                    return false;
                });
            });
        }

        function recycle()
        {
            var counter = 0;
            $('.table-row').each(function(){
                $(this).removeClass('alternate');
                if ((counter % 4) >= 2)
                {
                    $(this).addClass('alternate');
                }

                counter++;
            });
        }

        function replace_rows(data, action_row, data_row, next_on_success)
        {
            var probe = $(data);
            var new_rows;
            if (probe.get(0).tagName == 'TR')
                new_rows = $('<table>' + data + '</table>');
            else
                new_rows = $('<div>' + data + '</div>');

            var new_action_row = new_rows.find('.action-row');
            var new_data_row = new_action_row.prev();
            new_data_row.insertBefore(data_row);
            new_action_row.insertBefore(data_row);
            data_row.remove();
            action_row.remove();
            connect_row(new_action_row, false);

            var next_data_row = new_action_row.next();
            var next_action_row = new_action_row.next().next();

            recycle();

            $(document).trigger('newElements', new_action_row);

            if (new_action_row.find('.success').length > 0)
            {
                show_notice(new_action_row.find('.success').text());
                if (next_on_success)
                {
                    next_action_row.show();
                    next_data_row.find('.show-options').hide();
                    next_data_row.find('.hide-options').show();
                    next_action_row.find('input[type=text]').eq(0).focus();
                    handle_lazy(next_action_row);
                    new_action_row.hide();
                    new_data_row.find('.show-options').show();
                    new_data_row.find('.hide-options').hide();
                }
                else
                {
                    new_action_row.show();
                    new_data_row.find('.show-options').hide();
                    new_data_row.find('.hide-options').show();
                }
            }
        }

        function connect_form(form, action_row, data_row)
        {
            function submit_form()
            {
                var execute = function(){
                    $.ajax({
                        'type': 'POST',
                        'url': form.attr('action').replace('/action/', '/ajax/'),
                        'dataType': 'text',
                        'data': form.serialize(),
                        'success': function(x) {
                            replace_rows(x, action_row, data_row, form.attr('x:next') == "true");
                        },
                        'error': function(x) { $.mbox_error('{% trans "Alert" %}', x.responseText); }
                    });
                };

                if (form.attr('x:confirm'))
                    $.mbox(('{% trans "Confirm" %}'), form.attr('x:confirm'), { type: DIALOG_YES_NO, callback_closed_yes: execute});
                else
                    execute();

                return false;
            }

            var submit_button = form.find('.action-submit');
            submit_button.click(submit_form);
            form.find('input[type=text]').last().keypress(function(e) { if (e.which == 13) { submit_form(); return false; } } );
        }

        function connect_link(link, action_row, data_row)
        {
            if (link.attr('href').indexOf('_view') != -1)
                return;

            //link.css('background', 'yellow');
            link.click(function(){
                var execute = function()
                {
                    link.find('.loader').show();
                    $.ajax({
                        'type': 'POST',
                        'url': link.attr('href').replace('/action/', '/ajax/'),
                        'data': $('#csrf_form').serialize(),
                        'dataType': 'text',
                        'success': function(x) {
                            link.find('.loader').hide();
                            replace_rows(x, action_row, data_row, link.attr('x:next') == "true");
                        },
                        'error': function(x) {
                            link.find('.loader').hide();
                            $.mbox_error('{% trans "Alert" %}', x.responseText);
                        }
                    });
                };

                if (link.attr('x:confirm'))
                    $.mbox(('{% trans "Confirm" %}'), link.attr('x:confirm'), { type: DIALOG_YES_NO, callback_closed_yes: execute});
                else
                    execute();
                return false;
            });
        }

        function connect_page()
        {
            $('.action-row').each(function(){
                var action_row      = $(this);
                connect_row(action_row, true);
            });

            handle_lazy($('.help-text'));

            recycle();
        }

        connect_page();

        function handler(e, containers)
        {
            connect_page();
        }

        $(document).bind('paginatorPageReplaced', handler);
        $(document).bind('tabLoaded', handler);
    });
    // ]]>
</script>
{% endif %}