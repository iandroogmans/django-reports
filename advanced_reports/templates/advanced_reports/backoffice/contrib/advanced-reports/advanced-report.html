{% load i18n %}

<script type="text/ng-template" id="/pagination.html">
    <ul class="pagination" ng-show="page_count > 1">
        <li ng-class="{disabled: search.page <= 1}"><a href ng-click="change_page(1)">&laquo;</a></li>
        <li ng-class="{disabled: search.page <= 1}"><a href ng-click="change_page(search.page-1)">&lt;</a></li>
        <li><a href>{% trans "Page {{ search.page }} of {{ page_count }}" %}</a></li>
        <li ng-class="{disabled: search.page >= page_count}"><a href ng-click="change_page(search.page+1)">&gt;</a></li>
        <li ng-class="{disabled: search.page >= page_count}"><a href ng-click="change_page(page_count)">&raquo;</a></li>
    </ul>
</script>

<div ng-controller="AdvancedReportCtrl">
    <div class="alert alert-success alert-dismissable" ng-show="success">
        <button type="button" class="close" ng-click="success=null" aria-hidden="true">&times;</button>
        {% verbatim %}
        {{ success }}
        {% endverbatim %}
    </div>

    <div class="modal fade" tabindex="-1" role="dialog" bo-element="action_form_popup">
        <div class="modal-dialog-extra-padding modal-dialog">
            <div class="modal-content">
                <form bo-element="action_form_form">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                        <h4 class="modal-title" ng-bind="form.verbose_name"></h4>
                    </div>
                    <div class="modal-body">
                        <div class="form-horizontal" role="form" ng-bind-html-unsafe="form.form"></div>
                    </div>
                    <div class="modal-footer">
                        <button ng-disabled="isLoading()" type="button" class="btn btn-default" ng-click="action_form_popup.modal('hide')">{% trans "Cancel" %}</button>
                        <input ng-disabled="isLoading()" type="submit" class="btn btn-primary" ng-click="submit_form(form)" value="{% templatetag openvariable %}form.submit||'{% trans "Submit" %}'{% templatetag closevariable %}">
                    </div>
                </form>
            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->

    <div class="modal fade" tabindex="-1" role="dialog" bo-element="action_confirm_popup">
        <div class="modal-dialog-extra-padding modal-dialog">
            <div class="modal-content">
                <form>
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                        <h4 class="modal-title">{% trans "Are you sure?" %}</h4>
                    </div>
                    <div class="modal-body" ng-bind="action_to_confirm.confirm"></div>
                    <div class="modal-footer">
                        <button ng-disabled="isLoading()" type="button" class="btn btn-default" ng-click="action_confirm_popup.modal('hide')">{% trans "Cancel" %}</button>
                        <input ng-disabled="isLoading()" type="submit" class="btn btn-primary" ng-click="action_to_confirm.execute()" value="{% verbatim %}{{ action_to_confirm.verbose_name }}{% endverbatim %}">
                    </div>
                </form>
            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->

    <div class="modal fade" tabindex="-1" role="dialog" bo-element="multiple_action_confirm_popup">
        <div class="modal-dialog-extra-padding modal-dialog">
            <div class="modal-content">
                <form>
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                        <h4 class="modal-title" ng-bind="multiple_action_to_confirm.verbose_name"></h4>
                    </div>
                    <div class="modal-body">
                        {% trans "Are you sure you want to do this on multiple items?" %}
                    </div>
                    <div class="modal-footer">
                        <button ng-disabled="isLoading()" type="button" class="btn btn-default" ng-click="multiple_action_confirm_popup.modal('hide')">{% trans "Cancel" %}</button>
                        <input ng-disabled="isLoading()" type="submit" class="btn btn-primary" ng-click="multiple_action_to_confirm.execute()" value="{% verbatim %}{{ multiple_action_to_confirm.verbose_name }}{% endverbatim %}">
                    </div>
                </form>
            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->

    <div class="modal fade" tabindex="-1" role="dialog" bo-element="error_popup">
        <div class="modal-dialog-extra-padding modal-dialog">
            <div class="modal-content alert-danger">
                <form>
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                        <h4 class="modal-title">{% trans "Error" %}</h4>
                    </div>
                    <div class="modal-body" ng-bind="error_message"></div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-danger" ng-click="error_popup.modal('hide')">{% trans "Close" %}</button>
                    </div>
                </form>
            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->

    <div class="modal fade" tabindex="-1" role="dialog" bo-element="detail_popup">
        <div class="modal-dialog-extra-padding modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h4 class="modal-title" ng-bind="detail_action.verbose_name"></h4>
                </div>
                <div class="modal-body" compile="detail_action_content"></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" ng-click="detail_popup.modal('hide')">{% trans "Close" %}</button>
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->

    <div ng-show="show_header()" class="action-bar clearfix">
        <form class="form-inline col-lg-8 col-md-7 col-sm-6" role="form" ng-submit="apply_filters()">
            <div class="form-group" ng-show="report.search_fields">
                <input type="text" class="form-control" ng-model="filters.q" title="{% templatetag openvariable %}report.searchable_columns{% templatetag closevariable %}">
            </div>
            {% verbatim %}
            <div class="form-group" ng-repeat="field in report.filter_fields" ng-show="report.filter_fields">
                <select class="form-control" ng-model="$parent.filters[field]">
                  <option ng-repeat="(value, name) in report.filter_values[field]" value="{{value}}">{{name}}</option>
                </select>
            </div>
            {% endverbatim %}
            <button type="submit" class="btn btn-primary">{% trans "Search" %}</button>
            <div class="checkbox">
                <label><a href ng-show="has_applied_filters()" ng-click="remove_filters()">{% trans "show all" %}</a></label>
            </div>
        </form>

        <form ng-submit="execute_multiple_action()" class="form-inline col-lg-4 col-md-5 col-sm-6 align-right" role="form" ng-show="show_action_select()">
            <div class="form-group">
                <select ng-model="multiple_action" class="form-control">
                    <option value="" disabled>{% trans "With selected:" %}</option>
                    {% verbatim %}
                    <option ng-repeat="action in report.multiple_action_list" value="{{ action.method }}">{{ action.verbose_name }}</option>
                    {% endverbatim %}
                </select>
            </div>

            <button type="submit" class="btn btn-success">{% trans "Execute" %}</button>
        </form>
    </div>

    <div ng-include="'/pagination.html'"></div>

    <div class="tablecontainer" ng-show="report && !single_action">
        <table class="data table table-striped">
            <thead>
                <tr ng-show="report.all_selected && report.item_count > report.items_per_page" ng-class="{warning: !report.all_selected_global, success: report.all_selected_global}">
                    {% verbatim %}
                    <td colspan="{{ report.header.length + 2 }}">
                        {% endverbatim %}
                        {% trans "Only {{ selected_count() }} selected. Select all {{ report.item_count }}?" %}
                        <a href ng-hide="report.all_selected_global" ng-click="report.all_selected_global=true">{% trans "Yes" %}</a>
                        <strong ng-show="report.all_selected_global">{% trans "Yes" %}</strong>
                        <a href ng-show="report.all_selected_global" ng-click="report.all_selected_global=false;report.all_selected=false;selected={}">{% trans "Clear selection" %}</a>
                        {% verbatim %}
                    </td>
                    {% endverbatim %}
                </tr>
                <tr>
                    {% verbatim %}
                    <th ng-style="{width: {true: '24px', false: '0'}[report.multiple_actions]}">
                        <input type="checkbox" ng-model="report.all_selected" ng-click="update_selected()" ng-show="report.multiple_actions">
                    </th>
                    {% endverbatim %}
                    <th ng-repeat="column in report.header" ng-style="column.style">
                        <span ng-bind="column.verbose_name" ng-show="!column.sortable"></span>
                        <a href ng-bind="column.verbose_name" ng-show="column.sortable" ng-click="change_order(column.order_by)"></a>
                        <span ng-show="report.extra.order_field==column.name" ng-bind="{true:'&darr;', false:'&uarr;'}[report.extra.ascending]"></span>
                    </th>
                    <th></th>
                </tr>
            </thead>

            <tbody ng-repeat="item in report.items">
                <tr ng-click="toggle_expand(item)" ng-class="{success: multiple_succeeded[item.item_id], danger: multiple_failed[item.item_id]}">
                    <td><input type="checkbox" ng-model="selected[item.item_id]" ng-click="update_all_selected();$event.stopPropagation()" ng-show="report.multiple_actions"></td>
                    <td ng-repeat="value in item.values" ng-bind-html-unsafe="value.html" ng-style="value.style" ng-class="value.class"></td>
                    <td ng-show="has_expanded_content(item)">
                        <a ng-show="item.expanded" href>{% trans "hide details" %}</a>
                        <a ng-hide="item.expanded" href>{% trans "show details" %}</a>
                    </td>
                </tr>
                <tr ng-show="multiple_succeeded[item.item_id] && item.expanded" class="success">
                    {% verbatim %}
                    <td colspan="{{ report.header.length + 2 }}" ng-bind="multiple_succeeded[item.item_id]"></td>
                    {% endverbatim %}
                </tr>
                <tr ng-show="multiple_failed[item.item_id] && item.expanded" class="danger">
                    {% verbatim %}
                    <td colspan="{{ report.header.length + 2 }}" ng-bind="multiple_failed[item.item_id]"></td>
                    {% endverbatim %}
                </tr>

                <tr ng-show="item.expanded">
                    {% verbatim %}
                    <td colspan="{{ report.header.length + 2 }}">
                        <div class="btn-group">

                            <a class="btn {{ action.css_class|default:'btn-default' }}" link-to="get_action_link(item, action)" ng-click="execute_action(item, action)" ng-repeat="action in item.actions|filter:is_button_action">{{ action.verbose_name }}</a>
                        </div>
                        <div ng-repeat="action in item.actions|filter:is_inline_form_action">
                            <form bo-element="action_form_element" ng-submit="execute_inline_form_action(item, action, action_form_element)">
                                <div class="form-inline" role="form" compile="action.form"></div>
                            </form>
                        </div>
                        <div compile="item.extra_information" class="row extra_info"></div>
                    </td>
                    {% endverbatim %}
                </tr>
            </tbody>

            <tbody ng-show="report.items.length==0">
                <tr>
                    {% verbatim %}
                    <td colspan="{{ report.header.length + 2 }}">
                    {% endverbatim %}
                        <small>{% blocktrans with advreport.verbose_name_plural as items_name %}No {{ items_name }} to show...{% endblocktrans %}</small>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <div ng-include="'/pagination.html'"></div>

    <div class="btn-group" ng-show="single_action">
        {% verbatim %}
        <a
         class="btn {{ action.css_class|default:'btn-default' }}"
         link-to="get_action_link(report.items[0], action)"
         ng-click="execute_action(report.items[0], action)"
         ng-repeat="action in report.items[0].actions|filter:is_single_action"
         ng-bind="action.verbose_name"></a>
        {% endverbatim %}
    </div>
</div>

<script type="text/javascript">
function AdvancedReportCtrl($scope, $http, $location, boUtils, $timeout, boApi) {
    $scope.report = null;
    $scope.page_count = null;
    $scope.filters = {};
    $scope.applied_filters = {};
    $scope.search = $location.search() || {};
    $scope.single_action = $scope.view.params.action || null;
    $scope.selected = {};

    $scope.$watch(function(){
        return $location.search();
    }, function(search){
        $scope.search = search;
        $scope.fetch_report();
    }, true);

    $scope.fetch_report = function() {
        if (!$scope.search.page)
            $scope.search.page = 1;
        else
            $scope.search.page = parseInt($scope.search.page);

        for (var j in $scope.search){
            if (typeof $scope.search[j] === 'undefined')
                delete $scope.search[j];
        }

        $scope.filters = {};
        for (var m in $scope.search){
            if ($scope.search.hasOwnProperty(m)){
                if (['page', 'order'].indexOf(m) === -1)
                {
                    $scope.filters[m] = $scope.search[m];
                }
            }
        }

        if ($scope.view.params.updateLocation)
            $location.search($scope.search);

        var qs_list = [];
        for (var k in $scope.search)
            qs_list.push(encodeURIComponent(k) + '=' + encodeURIComponent($scope.search[k]));
        var qs = '?' + qs_list.join('&');

        $scope.view.action('fetch', {}, false, qs).then(function(data){
            $scope.report = data;
            if (data.item_count == 1)
                $scope.toggle_expand($scope.report.items[0]);
            $scope.page_count = Math.floor(data.item_count / data.items_per_page) + 1;
            $scope.selected = {};
            $scope.multiple_action_dict = {};
            angular.forEach($scope.report.multiple_action_list, function(value){
                $scope.multiple_action_dict[value.method] = value;
            });
        }, function(error){
            $scope.error = error;
        });
    };

    $scope.show_header = function(){
        return $scope.report.report_header_visible
                && !$scope.single_action
                && ($scope.filter_fields || $scope.search_fields || $scope.report.multiple_actions);
    };

    $scope.change_page = function(page){
        if (page < 1 || page > $scope.page_count || $scope.search.page == page)
            return;
        $scope.search.page = page;
        $scope.fetch_report();
    };

    $scope.has_expanded_content = function(item){
        return (item.extra_information.length > 0 || item.actions.length > 0);
    };

    $scope.toggle_expand = function(item) {
        if (!item.expanded && $scope.has_expanded_content(item)) {
            item.expanded = true;
            $scope.$broadcast('item_expanded', item.item_id);
            $scope.fetch_lazy_divs(item);
        } else {
            item.expanded = false;
        }
    };

    $scope.show_action_select = function(){
        return $scope.report && $scope.report.multiple_actions && !boUtils.isEmpty($scope.selected);
    };

    $scope.update_selected = function(){
        if ($scope.report.all_selected){
            angular.forEach($scope.report.items, function(item){
                $scope.selected[item.item_id] = true;
            });
        }else{
            $scope.selected = {};
        }
    };

    $scope.update_all_selected = function(selected){
        if (!selected){
            $scope.report.all_selected = false;
        }
        angular.forEach($scope.selected, function(value, key){
            if (!value){
                delete $scope.selected[key];
            }
        });
    };

    $scope.selected_count = function(){
        return boUtils.keyCount($scope.selected);
    };

    $scope.change_order = function(order_by) {
        var ascending = $scope.report.extra.order_by != order_by || !$scope.report.extra.ascending;
        $scope.search.order = (ascending ? '' : '-') + order_by;
        $scope.search.page = 1;
        $scope.fetch_report();
    };

    $scope.has_applied_filters = function() {
        var count = 0;
        for (var key in $scope.search)
            if (key != 'order' && key != 'page')
                count += 1;
        return count > 0;
    };

    $scope.apply_filters = function() {
        $scope.search = {order: $scope.search.order};
        for (var k in $scope.filters)
            $scope.search[k] = $scope.filters[k];
        $scope.search.page = 1;
        $scope.fetch_report();
    };

    $scope.remove_filters = function() {
        $scope.loader='search';
        $scope.filter = {};
        $scope.search = {order: $scope.search.order, page: 1};
        $scope.fetch_report();
    };

    $scope.update_item = function(item, new_item, expand_next) {
        for (var key in new_item) {
            if (new_item.hasOwnProperty(key))
                item[key] = new_item[key];
        }
        if (expand_next)
        {
            var this_item_id = $scope.report.items.indexOf(item);
            if (this_item_id < $scope.report.items.length - 1)
            {
                $scope.toggle_expand(item);
                $scope.toggle_expand($scope.report.items[this_item_id+1]);
            }
        }

        $scope.fetch_lazy_divs(item);
    };

    $scope.execute_multiple_action = function(){
        if (!$scope.multiple_action || $scope.multiple_action == ''){
            return;
        }
        var action = $scope.multiple_action_dict[$scope.multiple_action];
        $scope.multiple_action = '';
        var id_list = [];
        angular.forEach($scope.selected, function(value, key){
            if (value){
                id_list.push(key.toString());
            }
        });

        if ($scope.is_link_action(action)){
            var link_params = {
                report_method: action.method,
                items: id_list.join(','),
                global: $scope.report.all_selected_global
            };
            var url = $scope.view.action_link('multiple_action_view', link_params);
            window.location.href = url;
        }else{
            var execute = function(){
                if (action.confirm){
                    $scope.multiple_action_confirm_popup.modal('hide');
                }
                var action_params = {
                    report_method: action.method,
                    items: id_list.join(','),
                    global: $scope.report.all_selected_global
                };
                $scope.view.action('multiple_action', action_params, false).then(function(data){
                    $scope.multiple_succeeded = data.succeeded;
                    $scope.multiple_failed = data.failed;
                    $scope.fetch_report();
                });
            };

            if (action.confirm){
                $scope.multiple_action_confirm_popup.modal('show');
                action.execute = execute;
                $scope.multiple_action_to_confirm = action;
            }else{
                execute();
            }
        }
    };

    $scope.execute_action = function(item, action, force){
        if ($scope.is_link_action(action))
            return;

        if (action.form){
            $scope.form = action;
            $scope.form.item = item;
            $scope.action_form_popup.modal('show');
        } else {
            var execute = function(){
                $scope.view.action('action', {method: action.method, pk: item.item_id}, false).then(function(data){
                    $scope.action_confirm_popup.modal('hide');
                    if (data.item){
                        $scope.update_item(item, data.item, action.next_on_success);
                        $scope.show_success(data.success);
                        $scope.trigger_success_attr(action);
                    } else {
                        $scope.detail_action = action;
                        $scope.detail_action_content = data;
                        $scope.detail_popup.modal('show');
                    }

                }, function(error){
                    $scope.action_confirm_popup.modal('hide');
                    $scope.show_error(error);
                });
            };

            if (action.confirm && !force){
                action.execute = execute;
                $scope.action_to_confirm = action;
                $scope.action_confirm_popup.modal('show');
            } else {
                execute();
            }
        }
    };

    $scope.trigger_success_attr = function(action){
        var success_attr = $scope.$eval($scope.view.params.success);
        if (success_attr && success_attr[action.method]){
            $scope.$eval(success_attr[action.method]);
        }
    };

    $scope.show_success = function(success){
        boApi.messages.push({message: success, level: 25});
    };

    $scope.show_error = function(error){
        $scope.error_message = error;
        $scope.error_popup.modal('show');
    };

    $scope.submit_form = function(form) {
        var data = $scope.action_form_form.serialize();
        var item = form.item;

        $scope.view.action('action', {method: form.method, pk: item.item_id, data: data}, false).then(function(result){
            if (result.success){
                $scope.update_item(item, result.item, form.next_on_success);
                $scope.show_success(result.success);
                $scope.trigger_success_attr(form);
                $scope.form = null;
                $scope.action_form_popup.modal('hide');
            }else{
                form.form = result.response_form;
                $scope.form = form;
            }
        }, function(error){
            $scope.action_form_popup.modal('hide');
            $scope.show_error(error);
        });
    };

    $scope.execute_inline_form_action = function(item, action, action_form_element){
        var data = action_form_element.serialize();
        $scope.view.action('action', {method: action.method, pk: item.item_id, data: data}, false).then(function(result){
            if (result.success){
                $scope.update_item(item, result.item, action.next_on_success);
                $scope.show_success(result.success);
                $scope.trigger_success_attr(action);
            }else{
                action.form = result.response_form;
            }
        }, function(error){
            alert(error);
        });
    };

    $scope.fetch_lazy_divs = function(item) {
        var binds = item.extra_information.split('ng-bind-html-unsafe="');
        binds.splice(0, 1);

        var fetchBindIndex = function(i) {
            var bind = binds[i].split('"')[0];
            binds[i] = bind;
            var parts = bind.split('__');
            if (parts[0] == 'lazydiv')
            {
                $http.get($scope.settings.base + 'action/' + parts[2] + '/' + parts[1] + '/').
                success(function(data, status) {
                    $scope[bind] = data;
                }).
                error(function(data, status) {
                    $scope[bind] = 'error';
                });
            }
        };

        for (var i = 0; i < binds.length; i++) {
            fetchBindIndex(i);
        }
    };

    $scope.is_button_action = function(action){
        return !action.form || action.form_via_ajax;
    };

    $scope.is_inline_form_action = function(action){
        return action.form && !action.form_via_ajax;
    };

    $scope.is_link_action = function(action){
        return boUtils.endsWith(action.method, '_view');
    };

    $scope.is_single_action = function(action){
        if (!$scope.single_action || (action.form && !action.form_via_ajax)){
            return false;
        }
        if ($scope.single_action == '*'){
            return true;
        }
        return $scope.single_action.split(',').indexOf(action.method) > -1;
    };

    $scope.get_action_link = function(item, action){
        if ($scope.is_link_action(action))
            return $scope.view.action_link('action_view', {report_method: action.method, pk: item.item_id});
        return '';
    };
}
</script>
