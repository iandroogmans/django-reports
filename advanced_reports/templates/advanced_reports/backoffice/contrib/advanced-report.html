{% load i18n %}
<div ng-controller="AdvancedReportCtrl" ng-init="fetch_report()">
    <pre ng-show="false" ng-bind="params|json"></pre>

    <div class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" bo-element="action_popup">
        <div class="modal-dialog">
            <div class="modal-content">
                <form bo-element="action_form">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                        <h4 class="modal-title" ng-bind="form.verbose_name"></h4>
                    </div>
                    <div class="modal-body">
                        {% csrf_token %}
                        <table ng-bind-html-unsafe="form.form"></table>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" ng-click="action_popup.modal('hide')">{% trans "Cancel" %}</button>
                        <input type="submit" class="btn btn-primary" ng-click="submit_form(form)" value="{% templatetag openvariable %}form.submit||'{% trans "Submit" %}'{% templatetag closevariable %}">
                    </div>
                </form>
            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->

    <div ng-show="report.search_fields" class="well">
        <form class="form-inline" role="form" ng-submit="apply_filters()">
            <div class="form-group">
                <input type="text" class="form-control" ng-model="filters.q" title="{% templatetag openvariable %}report.searchable_columns{% templatetag closevariable %}">
            </div>
            <button type="submit" class="btn btn-primary">Search</button>
            <div class="checkbox">
                <label><a href ng-show="has_applied_filters()" ng-click="remove_filters()">{% trans "show all" %}</a></label>
            </div>
        </form>
    </div>

    <p ng-show="report">
        <span ng-show="page > 1"><a href ng-click="change_page(1)">&lt;&lt;</a></span>
        <span ng-show="page > 1"><a href ng-click="change_page(page-1)">&lt;</a></span>
        {% trans "Page {{ page }} of {{ page_count }}" %}
        <span ng-show="page < page_count"><a href ng-click="change_page(page+1)">&gt;</a></span>
        <span ng-show="page < page_count"><a href ng-click="change_page(page_count)">&gt;&gt;</a></span>
    </p>

    <div class="tablecontainer" ng-show="report">
        <table class="data table table-hover">
            <tr>
                <th ng-repeat="column in report.header" ng-style="column.style">
                    <span ng-bind="column.verbose_name" ng-show="!column.sortable"></span>
                    <a href ng-bind="column.verbose_name" ng-show="column.sortable" ng-click="change_order(column.order_by)"></a>
                    <span ng-show="report.extra.order_field==column.name" ng-bind="{true:'&darr;', false:'&uarr;'}[report.extra.ascending]"></span>
                </th>
            </tr>

            <tbody ng-repeat="item in report.items">
                <tr ng-click="toggle_expand(item)">
                    <td ng-repeat="value in item.values" ng-bind-html-unsafe="value.html" ng-style="value.style" ng-class="value.class"></td>
                </tr>

                <tr ng-show="item.expanded">
                    <td colspan="{% templatetag openvariable %}report.header.length{% templatetag closevariable %}">
                        <div class="btn-group">
                            <a class="btn btn-default" href ng-bind="action.verbose_name" ng-click="execute_action(item, action)" ng-repeat="action in item.actions"></a>
                        </div>
                        <div compile="item.extra_information"></div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <p ng-show="report">
        <span ng-show="page > 1"><a href ng-click="change_page(1)">&lt;&lt;</a></span>
        <span ng-show="page > 1"><a href ng-click="change_page(page-1)">&lt;</a></span>
        {% trans "Page {{ page }} of {{ page_count }}" %}
        <span ng-show="page < page_count"><a href ng-click="change_page(page+1)">&gt;</a></span>
        <span ng-show="page < page_count"><a href ng-click="change_page(page_count)">&gt;&gt;</a></span>
    </p>
</div>

<script type="text/javascript">
function AdvancedReportCtrl($scope, $http) {
    $scope.loader = 'report';
    $scope.loaded = true;
    $scope.report = null;
    $scope.page = 1;
    $scope.page_count = null;
    $scope.current_order_by = null;
    $scope.filters = {};
    $scope.applied_filters = {};

    $scope.$on('$routeChangeSuccess', function (){
        $scope.fetch_report();
    });

    $scope.fetch_report = function() {
        $scope.loaded = false;
        if ($scope.current_order_by)
            $scope.filters['order'] = $scope.current_order_by;

        var qs_list = [];
        for (var k in $scope.filters)
            if ($scope.filters[k])
                qs_list.push(encodeURIComponent(k) + '=' + encodeURIComponent($scope.filters[k]));
        for (var k in $scope.params)
            if (k != 'tab')
                qs_list.push(encodeURIComponent(k) + '=' + encodeURIComponent($scope.params[k]));
        var qs = '&' + qs_list.join('&');

        $scope.view.action('fetch', {}, false, '?page=' + $scope.page + qs).then(function(data){
            $scope.report = data;
            $scope.loaded = true;
            $scope.page_count = Math.floor(data.item_count / data.items_per_page) + 1;
        }, function(error){
            $scope.error = error;
        });
    };

    $scope.change_page = function(page) {
        $scope.loader = 'page';
        $scope.page = page;
        $scope.fetch_report();
    };

    $scope.toggle_expand = function(item) {
        if (!item.expanded && (item.extra_information.length > 0 || item.actions.length > 0)) {
            item.expanded = true;
            $scope.fetch_lazy_divs(item);
        } else {
            item.expanded = false;
        }
    };

    $scope.change_order = function(order_by) {
        $scope.loader = 'order_' + order_by;
        var ascending = $scope.report.extra.order_by != order_by || !$scope.report.extra.ascending;
        $scope.current_order_by = (ascending ? '' : '-') + order_by;
        $scope.page = 1;
        $scope.fetch_report();
    };


    $scope.has_applied_filters = function() {
        var count = 0;
        for (var key in $scope.applied_filters)
            count += 1;
        return count > 0;
    };

    $scope.apply_filters = function() {
        $scope.applied_filters = {};
        for (var k in $scope.filters)
            $scope.applied_filters[k] = $scope.filters[k];
        $scope.loader='search';
        $scope.page = 1;
        $scope.fetch_report();
    };

    $scope.remove_filters = function() {
        $scope.loader='search';
        $scope.filters = {};
        $scope.applied_filters = {};
        $scope.page = 1;
        $scope.fetch_report();
    };

    $scope.update_item = function(item, new_item) {
        for (var key in new_item) {
            item[key] = new_item[key];
        }
        $scope.fetch_lazy_divs(item);
    };

    $scope.execute_action = function(item, action) {
        if (action.form){
            $scope.form = action;
            $scope.form.item = item;
            $scope.action_popup.modal('show');
        } else {
            item.loading = true;
            $scope.loader = 'action_' + action.method;

            $scope.view.action('action', {method: action.method, pk: item.item_id}, false).then(function(data){
                item.loading = false;
                $scope.update_item(item, data.item);
            }, function(error){
                item.loading = false;
                alert(error);
            });
        }
    };

    $scope.submit_form = function(form) {

        var data = $scope.action_form.serialize();
        var item = form.item;

        item.loading = true;
        $scope.loader = 'action_' + form.method;

        $scope.view.action('action', {method: form.method, pk: item.item_id, data: data}, false).then(function(result){
            item.loading = false;
            if (result.success){
                $scope.update_item(item, result.item);
                $scope.form = null;
                $scope.action_popup.modal('hide');
            }else{
                form.form = result.response_form;
                $scope.form = form;
            }
        }, function(error){
            item.loading = false;
            form.form = data;
            $scope.form = form;
        });
    };

    $scope.fetch_lazy_divs = function(item) {
        var binds = item.extra_information.split('ng-bind-html-unsafe="');
        binds.splice(0, 1);

        var fetchBindIndex = function(i) {
            var bind = binds[i].split('"')[0];
            binds[i] = bind;
            var parts = bind.split('__');
            if (parts[0] == 'lazydiv')
            {
                $http.get($scope.settings.base + 'action/' + parts[2] + '/' + parts[1] + '/').
                success(function(data, status) {
                    $scope[bind] = data;
                }).
                error(function(data, status) {
                    $scope[bind] = 'error';
                });
            }
        };

        for (var i = 0; i < binds.length; i++) {
            fetchBindIndex(i);
        }
    };
}
</script>